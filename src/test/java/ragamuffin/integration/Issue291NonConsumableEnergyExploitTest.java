package ragamuffin.integration;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import ragamuffin.building.Inventory;
import ragamuffin.building.Material;
import ragamuffin.core.InteractionSystem;
import ragamuffin.entity.Player;

import static org.junit.jupiter.api.Assertions.*;

/**
 * Integration tests for Issue #291: Non-consumable use items (NEWSPAPER, TEXTBOOK, HYMN_BOOK)
 * must be removed from inventory on use to prevent infinite energy exploit.
 */
class Issue291NonConsumableEnergyExploitTest {

    private Player player;
    private Inventory inventory;
    private InteractionSystem interactionSystem;

    @BeforeEach
    void setUp() {
        player = new Player(0, 1, 0);
        inventory = new Inventory(36);
        interactionSystem = new InteractionSystem();
    }

    @Test
    void testNewspaperIsConsumedOnUse() {
        inventory.addItem(Material.NEWSPAPER, 1);
        player.setEnergy(50);

        interactionSystem.useItem(Material.NEWSPAPER, player, inventory);

        assertEquals(0, inventory.getItemCount(Material.NEWSPAPER),
            "NEWSPAPER should be consumed (removed) from inventory on use");
    }

    @Test
    void testTextbookIsConsumedOnUse() {
        inventory.addItem(Material.TEXTBOOK, 1);
        player.setEnergy(50);

        interactionSystem.useItem(Material.TEXTBOOK, player, inventory);

        assertEquals(0, inventory.getItemCount(Material.TEXTBOOK),
            "TEXTBOOK should be consumed (removed) from inventory on use");
    }

    @Test
    void testHymnBookIsConsumedOnUse() {
        inventory.addItem(Material.HYMN_BOOK, 1);
        player.setEnergy(50);

        interactionSystem.useItem(Material.HYMN_BOOK, player, inventory);

        assertEquals(0, inventory.getItemCount(Material.HYMN_BOOK),
            "HYMN_BOOK should be consumed (removed) from inventory on use");
    }

    @Test
    void testNewspaperCannotBeUsedRepeatedlyWithOneItem() {
        inventory.addItem(Material.NEWSPAPER, 1);
        player.setEnergy(0);

        // First use should restore energy and consume the item
        interactionSystem.useItem(Material.NEWSPAPER, player, inventory);
        float energyAfterFirst = player.getEnergy();
        assertTrue(energyAfterFirst > 0, "First NEWSPAPER use should restore energy");

        // Second use with no items left should not restore additional energy
        player.setEnergy(0);
        interactionSystem.useItem(Material.NEWSPAPER, player, inventory);

        assertEquals(0, inventory.getItemCount(Material.NEWSPAPER),
            "No NEWSPAPER remaining after first use");
    }

    @Test
    void testNewspaperStackDecrementsByOne() {
        inventory.addItem(Material.NEWSPAPER, 3);
        player.setEnergy(50);

        interactionSystem.useItem(Material.NEWSPAPER, player, inventory);

        assertEquals(2, inventory.getItemCount(Material.NEWSPAPER),
            "Stack of 3 NEWSPAPERs should decrement to 2 after one use");
    }

    @Test
    void testFlavourItemsAreNotConsumedOnUse() {
        // Purely informational items should NOT be consumed
        Material[] flavourItems = {
            Material.HAIR_CLIPPERS, Material.NAIL_POLISH, Material.BROKEN_PHONE,
            Material.DODGY_DVD, Material.PLYWOOD, Material.PIPE,
            Material.COMPUTER, Material.OFFICE_CHAIR, Material.STAPLER,
            Material.PETROL_CAN, Material.DIAMOND
        };

        for (Material m : flavourItems) {
            inventory.addItem(m, 1);
            interactionSystem.useItem(m, player, inventory);
            assertEquals(1, inventory.getItemCount(m),
                m + " (flavour item) should NOT be consumed from inventory on use");
        }
    }
}
